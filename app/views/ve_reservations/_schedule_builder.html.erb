<% 
existing_ids = @obj.new_schedules.map(&:ve_vehicle_ids).flatten.uniq
vehicles = VeVehicle.order('vehicle_no')
vehicles = existing_ids.empty? ? vehicles.where('active = 1') : vehicles.where('active = 1 or id in (?)', existing_ids)
@ve_vehicle_options = vehicles.map { |v| lbl = "#{v.vehicle_no} #{v.year} #{v.make} #{v.model} #{v.assignment}"; [lbl, v.id, {title: lbl, data: {no: v.vehicle_no}}] }
%>
<% @obj.new_schedules.each_with_index { |s, i| %>
	<%= partial 've_reservations/schedule_vehicles', s: s, f: f, i: i %>
<% } %>
<tr id="add-schedule-row">
	<th>Add Fields/Dates</th>
	<td class="form-inline">
		<a id="add-schedule" href="#"><i class="fa fa-plus-circle"></i> Click to Add Schedule</a>
		<%= hidden_field 'obj[check_new_schedules]', 1 %>
	</td>
</tr>
<script>
	var schedule_count = <%= @obj.new_schedules.size %>;
	var schedule_html = <%= partial('ve_reservations/schedule_vehicles', f: f, s: {}, i: '__COUNT__').to_json.html_safe %>;
	function init_schedule(s) {
		var f = s.find('.schedule-dates');
		var v = f.val().split(',');
		var mn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
		var opts = {
			numberOfMonths: 3, 
			altField: f,
			changeMonth: true,
			changeYear: true, 
			monthNames: mn,
			monthNamesShort: mn,
			separator: ',',
			dateFormat: 'yy-mm-dd',
			dayNamesMin: ['S', 'M', 'T', 'W', 'T', 'F', 'S']
		}
		if(v[0]) {
			opts.defaultDate = v[0];
			opts.addDates = v;
		}
		var cal = s.find('.mcal').multiDatesPicker(opts);
		s.find('.schedule-ve-vehicle-ids').select2({
			closeOnSelect: false,
			templateSelection: function(data, li) {
				return $(data.element).data('no');
			}
		});
		s.find('.schedule-deselect-all').click(function(e) {
			e.preventDefault();
			cal.multiDatesPicker('resetDates');
		});
		s.find('.schedule-delete').click(function(e) {
			if(confirm('Are you sure you want to remove these scheduled days?')) {
				s.remove();
				number_schedules();
			}
		});
		s.find('.schedule-begin, .schedule-end').inputmask('hh:mm t', {showMaskOnHover: true});
	}
	$('#add-schedule').click(function(e) {
		e.preventDefault();
		var s = $(schedule_html.replace(/__COUNT__/g, schedule_count));
		schedule_count++;
		$('#add-schedule-row').before(s);
		init_schedule(s);
		number_schedules();
	});
	$('.schedule').each(function(i, e) {
		init_schedule($(e));
	});
	var number_schedules = function() {
		$('.schedule').each(function(i, e) {
			$(e).find('span.num').html(i + 1);
		});
	}
	number_schedules();
</script>