<% o.name = 'Blank Template.pdf' if !request.post? && o.new_record? %>
<%= f.tr_select :doc_template_id, DocTemplate.order('name').map { |t| [t.name, t.id, data: {margins: [t.margin_top, t.margin_bottom, t.margin_left, t.margin_right].join(',')}] }, label: 'Template', include_blank: 'Blank Template', tr: {class: 'generate'} %>
<% if !o.new_record? %>
	<tr>
		<th>Regenerate?</th>
		<td><label><%= check_box_tag 'obj[regenerate]', 1, o.regenerate %> 
		<% if o.is_a? Document %>
			Check to recreate the PDF document based off the template below.
		<% else %>
			Check here to recreate all PDF documents based on the template below. This will overwrite any changes made to individual documents.
		<% end %>
		</label></td>
	</tr>
<% end %>
<%= partial 'doc_templates/fields', f: f, o: o %>
<script>
	var set_file_name = function() {
	 $('#obj_name').val($('#obj_doc_template_id option:selected').text() + '.pdf');
	}
	$('#obj_doc_template_id').change(function(e) {
	 var $this = $(this);
	 var tr = $this.closest('tr');
	 var val = $this.val();
	 if(!val) {
		 return;
	 }
	 var option = $this.find('option:selected');
	 tr.addClass('busy-bg');
	 $.ajax({
		 url: '<%= url_for action: :apply %>/' + val,
		 success: function(data, status, xhr) {
			 $('#obj_body').val(data);
			 CKEDITOR.instances.obj_body.setData(data);
			 set_file_name();
			 var margins = option.data('margins').split(',');
			 $('#obj_margin_top').val(margins[0]);
			 $('#obj_margin_bottom').val(margins[1]);
			 $('#obj_margin_left').val(margins[2]);
			 $('#obj_margin_right').val(margins[3]);
			 set_margins();
		 },
		 complete: function(xhr, status) {
			 tr.removeClass('busy-bg');
		 },
		 error: function(xhr, status, error) {
			 alert('Error fetching template.')
		 }
	 })
	});
</script>